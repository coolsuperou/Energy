# 工具制造电能数据平台 - 需求文档

## 项目概述

本系统是面向工具制造工厂的电能数据管理平台，实现从用电申请、审批调度、能耗监控到智能分析的全链路管理。系统按角色划分功能模块，覆盖五大用户角色。

---

## 业务流程

### 流程一：用电申请审批流程

```
车间用户提交用电申请（选设备、功率、时段、用途、紧急程度）
    ↓
系统生成申请编号，状态：待审批(pending)
    ↓
能源调度员查看待审批列表
    ↓
┌─────────────┬─────────────┬─────────────┐
│   批准       │   拒绝       │   调整       │
│ (approved)  │ (rejected)  │ (adjusted)  │
│ 直接通过     │ 附加拒绝原因  │ 修改时段后批准 │
└──────┬──────┴──────┬──────┴──────┬──────┘
       ↓             ↓             ↓
  系统自动生成    流程结束      系统按调整后
  能耗数据                    时段生成能耗数据
  （按小时记录                 
   峰/平/谷电价）              
       ↓                          ↓
  消息通知申请人审批结果 ←─────────┘
```

### 流程二：设备巡检任务流程

```
能源调度员创建巡检任务（巡检/维修/维护）
    ↓
任务状态：待进行(pending)
    ↓
调度员选择巡检员派单
    ↓
任务状态：进行中(in_progress)，通知巡检员
    ↓
巡检员执行任务
    ↓
巡检员提交巡检报告
    ↓
任务状态：已完成(completed)，记录完成时间
```

### 流程三：问题反馈处理流程

```
车间用户提交问题反馈（类型、描述、图片附件）
    ↓
系统生成反馈编号，状态：待处理(pending)
    ↓
能源调度员查看反馈列表
    ↓
┌──────────────────┬──────────────────┐
│   直接回复处理     │   派单给巡检员     │
│ （建议/问题类）    │ （故障类）         │
└────────┬─────────┴────────┬─────────┘
         ↓                  ↓
  更新状态为           自动创建维修任务
  resolved已解决       关联反馈ID
         ↓                  ↓
    通知反馈人          反馈状态→processing
                            ↓
                      巡检员完成维修
                            ↓
                      反馈状态→resolved
```

### 流程四：能耗监控与AI分析流程

```
已批准申请 → 系统按小时生成能耗数据
                ↓
        ┌───────┴───────┐
        ↓               ↓
   实时预警检测      数据汇总统计
   （调度员监控）    （经理查看）
        ↓               ↓
  功率超限/波动     各车间能耗对比
  → 预警通知       峰谷分布/费用统计
                        ↓
                  一键发送给AI分析
                        ↓
                  讯飞星火大模型
                  流式返回分析结果
                  （节能建议/预测预警）
```

### 流程五：技能认证审批流程

```
巡检员提交技能认证申请（上传证书图片）
    ↓
申请状态：待审核(pending)
    ↓
经理审核
    ↓
┌─────────────┬─────────────┐
│   通过       │   拒绝       │
│ (certified) │ (rejected)  │
└──────┬──────┴──────┬──────┘
       ↓             ↓
  巡检员获得      附加拒绝原因
  新技能资质      通知巡检员
```

### 流程六：排班与考勤流程

```
系统按月自动生成排班计划（除经理外所有人）
    ↓
经理查看排班表，按需手动调整
    ↓
调整后通知被调整人员
    ↓
员工每日上班打卡 → 下班打卡
    ↓
系统自动判断考勤状态（正常/迟到/早退/缺勤）
    ↓
自动计算工作时长
```

---

## 一、公共模块（所有角色）

### 1.1：用户登录
作为系统用户，我希望通过用户名和密码登录系统，以便访问对应角色的功能模块。

验收标准：
- 输入正确的用户名和密码后成功登录，返回用户信息（userId、username、role）
- 登录成功后根据角色自动跳转到对应首页（admin→/admin，dispatcher→/dispatcher，inspector→/inspector，manager→/manager，workshop→/workshop）
- 用户名或密码错误时返回明确的错误提示
- 已禁用（disabled）的用户无法登录
- 未登录用户访问需认证页面时自动重定向到登录页

### 1.2：用户注册
作为新用户，我希望能够注册账号，以便申请使用系统。

验收标准：
- 填写用户名、密码、姓名等基本信息完成注册
- 用户名不能重复，重复时给出提示
- 注册成功后需等待管理员分配角色

### 1.3：考勤打卡
作为系统用户，我希望进行上下班打卡，以便记录出勤情况。

验收标准：
- 记录每日上班打卡时间和下班打卡时间
- 根据排班时间自动判断考勤状态：正常(normal)、迟到(late)、早退(early_leave)、缺勤(absent)
- 自动计算工作时长
- 查看历史考勤记录和本周排班计划

### 1.4：业务评论
作为系统用户，我希望在申请和工单上发表评论，以便进行业务沟通。

验收标准：
- 支持在用电申请（application）和巡检任务（task）上发表评论
- 评论包含评论人、评论内容、评论时间

---


## 二、车间用户（workshop）

> 侧边栏菜单：首页概览 | 用电申请 | 能耗查看 | 故障报修 | 消息中心 | 个人中心

### 2.1：首页概览
作为车间用户，我希望在首页看到本车间的关键数据概览，以便快速了解当前状况。

验收标准：
- 显示今日用电量、本月用电量等关键指标
- 显示最近的申请状态和反馈处理进度
- 显示未读消息数量提醒

### 2.2：用电申请
作为车间用户，我希望提交和管理用电申请，以便获得设备用电授权。

验收标准：
- 选择设备、填写申请功率(kW)、用电日期、开始/结束时间、用电用途
- 设置紧急程度（normal普通、urgent紧急、critical严重）
- 提交后自动生成唯一申请编号（格式：AP+日期+序号）
- 申请初始状态为"待审批"（pending）
- 查看自己的申请列表，支持按状态筛选和分页
- 查看申请详情，包含审批意见、审批人、审批时间
- **申请详情页支持评论交流，申请人和审批人可以就该申请进行沟通**
- 按创建时间倒序排列

### 2.3：能耗查看
作为车间用户，我希望查看本车间的能耗数据，以便了解用电情况和费用。

验收标准：
- 查看今日能耗曲线（按小时展示功率变化）
- 查询历史日期范围的能耗数据
- 显示费用统计（按峰/平/谷分类汇总）

### 2.4：故障报修
作为车间用户，我希望提交和管理故障报修，以便及时报告和解决设备问题。

验收标准：
- 选择反馈类型：故障(fault)、建议(suggestion)、问题(question)、其他(other)
- 填写问题位置、紧急程度（normal/urgent/critical）、问题描述
- 支持上传图片附件（通过MinIO存储，支持多张图片，单张最大15MB，仅限图片格式）
- 提交后自动生成反馈编号（格式：FB+日期+序号）
- 反馈初始状态为"待处理"（pending）
- 查看自己的反馈列表，支持按状态筛选和分页
- 只有"待处理"状态的反馈可以撤回，撤回后状态变为"已撤回"（withdrawn）
- 只能撤回自己提交的反馈

### 2.5：消息中心
作为车间用户，我希望收到业务相关的消息通知，以便及时了解工作动态。

验收标准：
- 通知类型：审批通知(approval)、系统通知(system)
- 通知包含标题、内容、关联业务ID
- 支持标记已读/未读
- 侧边栏显示未读消息数量

### 2.6：个人中心
作为车间用户，我希望查看和修改个人资料。

验收标准：
- 查看基本信息（姓名、部门、电话、邮箱等）
- 可修改联系电话和邮箱
- 可上传和更换头像（图片文件，最大15MB，存储到MinIO）
- 上传新头像后旧头像自动删除
- 查看考勤记录和排班信息

---

## 三、能源调度员（dispatcher）

> 侧边栏菜单：工作台 | 申请审批(badge) | 电力调度 | 预警处理(badge) | 工单管理 | 消息通知 | 个人中心

### 3.1：工作台
作为能源调度员，我希望在工作台看到待办事项和关键数据概览，以便快速掌握工作状况。

验收标准：
- 显示待审批申请数量、待处理预警数量、进行中工单数量
- 显示今日关键指标（总用电量、预警次数等）
- 快捷入口：跳转到审批、预警、工单等模块

### 3.2：申请审批
作为能源调度员，我希望审批车间提交的用电申请，以便合理调配电力资源。

验收标准：
- 查看所有待审批申请列表，支持按车间筛选
- 申请列表按紧急程度和提交时间排序
- 三种审批操作：
  - 批准（approved）：直接通过申请
  - 拒绝（rejected）：附加拒绝原因
  - 调整（adjusted）：修改用电时间段后批准
- 审批后记录审批人、审批时间和审批意见
- 审批结果通过消息通知发送给申请人
- **申请详情页支持评论交流，调度员和申请人可以就该申请进行沟通**
- 查看所有申请记录，支持按状态（pending/approved/rejected/adjusted）和车间筛选
- 分页查询，按创建时间倒序排列
- 侧边栏badge显示待审批数量

### 3.3：电力调度
作为能源调度员，我希望查看实时功率监控和负载均衡情况，以便进行电力调度。

验收标准：
- 查看各车间实时功率数据
- 查看负载均衡状态
- 查看预警历史记录

### 3.4：预警处理
作为能源调度员，我希望实时监控各车间用电情况并处理预警，以便及时处理异常。

验收标准：
- 监控各车间实时功率是否超过限额
- 功率超限时生成预警通知（如第二车间超过700kW限额）
- 功率接近限额（85%-90%）时生成预警提醒
- 检测功率异常波动（平均功率低但峰值高）
- 侧边栏badge显示未处理预警数量

### 3.5：工单管理
作为能源调度员，我希望创建、派单和管理巡检/维修/维护工单，以便安排设备维护工作。

验收标准：
- 创建三种类型任务：巡检(inspection)、维修(repair)、维护(maintenance)
- 填写任务标题、描述、关联设备、截止日期
- 设置优先级：低(low)、普通(normal)、高(high)、紧急(urgent)
- 创建后任务状态为"待进行"（pending）
- 从巡检员列表中选择执行人进行派单
- 派单后任务状态直接变为"进行中"（in_progress），无需巡检员接单
- 系统发送任务分配通知给巡检员
- 分页查看所有任务列表
- 支持按状态（pending待进行/in_progress进行中/completed已完成）筛选
- 支持按类型（inspection/repair/maintenance）筛选
- 按创建时间倒序排列
- 查看和处理车间提交的问题反馈
- 查看所有反馈列表，支持按状态和类型筛选
- 回复反馈并更新状态（processing处理中/resolved已解决）
- 记录处理人和处理时间
- 查看反馈中上传的图片附件
- 对于故障类反馈，可以直接派单给设备巡检员（基于反馈内容自动创建维修任务，关联对应设备，并将反馈状态更新为processing）
- 派单后巡检员收到任务分配通知，任务中关联原始反馈ID便于追溯

### 3.6：消息通知
作为能源调度员，我希望收到业务相关的消息通知，以便及时了解工作动态。

验收标准：
- 通知类型：审批通知(approval)、任务通知(task)、预警通知(alert)、系统通知(system)
- 通知包含标题、内容、关联业务ID
- 支持标记已读/未读

### 3.7：个人中心
作为能源调度员，我希望查看和修改个人资料。

验收标准：
- 查看基本信息（姓名、部门、电话、邮箱等）
- 可修改联系电话和邮箱
- 可上传和更换头像（图片文件，最大15MB，存储到MinIO）
- 上传新头像后旧头像自动删除
- 查看考勤记录和排班信息

---


## 四、设备巡检员（inspector）

> 侧边栏菜单：工作台 | 我的任务 | 消息中心 | 个人中心

### 4.1：工作台
作为设备巡检员，我希望在工作台看到任务统计和工作概览，以便快速了解工作安排。

验收标准：
- 显示进行中任务数量、今日完成数量
- 查看今日待完成任务列表（截止日期≤今天的未完成任务）
- 查看本月完成工单数、按时完成率、累计完成工单数
- 查看近7天工作量趋势图
- 查看已认证的技能列表（如电气设备维修、机械设备检修、安全操作证等）
- 每项技能显示认证状态：已认证(certified)、待审核(pending)
- 提交技能认证申请，上传相关证书图片或文件（通过MinIO存储）
- 申请初始状态为"待审核"（pending），经理审核后更新状态

### 4.2：我的任务
作为设备巡检员，我希望查看和完成分配给我的任务，以便执行巡检维修工作。

验收标准：
- 查看分配给自己的任务列表，支持按状态筛选
- 任务分为两个标签页：进行中、已完成
- 按创建时间倒序排列
- 调度员分配任务后直接进入"进行中"(in_progress)状态，无需巡检员手动接单
- 填写巡检报告（文字描述）完成任务
- 提交后任务状态变为"已完成"（completed），记录完成时间
- 只能完成分配给自己的任务
- 查看设备列表和详情，包含设备名称、所属车间、额定功率、状态、位置、型号
- 设备状态分为：正常(normal)、预警(warning)、故障(fault)
- 支持按车间和状态筛选设备

### 4.3：消息中心
作为设备巡检员，我希望收到任务分配等消息通知，以便及时了解工作安排。

验收标准：
- 通知类型：任务通知(task)、系统通知(system)
- 通知包含标题、内容、关联业务ID
- 支持标记已读/未读

### 4.4：个人中心
作为设备巡检员，我希望查看和修改个人资料。

验收标准：
- 查看基本信息（姓名、部门、电话、邮箱等）
- 可修改联系电话和邮箱
- 可上传和更换头像（图片文件，最大15MB，存储到MinIO）
- 上传新头像后旧头像自动删除
- 查看考勤记录和排班信息

---

## 五、经理（manager）

> 侧边栏菜单：首页概览 | 数据分析 | AI分析 | 消息中心 | 个人中心
> 注：用户管理（含技能认证审核）、排班考勤管理为需求新增功能，需在侧边栏补充对应菜单项

### 5.1：首页概览
作为经理，我希望在首页看到全局关键数据概览，以便快速掌握整体运营状况。

验收标准：
- 显示全厂今日用电量、本月用电量、本月费用等关键指标
- 显示各车间用电排名
- 显示待处理事项（待审核认证等）

### 5.2：数据分析
作为经理，我希望查看各车间的能耗统计和分析报表，以便做出管理决策。

验收标准：
- 查看各车间能耗对比统计
- 查看时段用电分析（峰/平/谷占比）
- 查看成本统计和趋势
- 支持按日期范围查询
- 查看所有用电申请记录，支持按状态和车间筛选
- 分页查询，按创建时间倒序排列

### 5.3：AI分析
作为经理，我希望通过AI助手获取能耗分析和节能建议，以便优化用电策略。

验收标准：
- 支持流式对话（SSE），实时显示AI回复内容
- AI分析内容包括：能耗总览与趋势、峰谷时段分析、异常用电检测、节能优化建议、预测与预警
- 使用讯飞星火大模型（通过WebSocket通信）
- 提供以下快速操作指令，经理可一键触发对应分析：
  1. 能耗总览分析 — 汇总各车间今日/本月用电量、费用，给出整体评估
  2. 峰谷时段分析 — 分析各车间峰/平/谷用电占比，给出错峰建议
  3. 异常用电检测 — 检测功率异常波动、超限情况，定位问题车间
  4. 节能优化建议 — 基于历史数据给出降本增效建议
  5. 用电趋势预测 — 基于近期数据预测未来用电趋势和预警
- 每个快速指令自动携带对应的实际能耗数据发送给AI，AI基于真实数据给出针对性建议
- 支持自由对话，经理也可以手动输入问题与AI交流

### 5.4：用户管理（待补充侧边栏菜单）
作为经理，我希望管理系统用户，以便维护团队人员。

验收标准：
- 查看用户列表，支持按角色筛选
- 添加新用户（设置用户名、密码、姓名、角色、部门等）
- 编辑用户信息
- 启用/禁用用户账号
- 在用户管理中查看巡检员的技能认证申请
- 查看待审核的技能认证申请列表
- 查看申请人上传的证书图片/文件
- 审核通过后状态变为"已认证"（certified）
- 审核拒绝后状态变为"已拒绝"（rejected），附加拒绝原因

### 5.5：排班考勤管理（待补充侧边栏菜单）
作为经理，我希望管理人员排班并查看考勤记录、进行补卡，以便统一管理团队出勤。

验收标准：
- 系统按月自动生成排班计划（覆盖除经理外的所有角色用户）
- 自动排班规则：工作日默认白班，周末默认休息，巡检员按白班/夜班轮换
- 经理可以查看所有人员的排班表，支持按角色、部门筛选
- 经理可以手动调整任意人员的排班（修改班次类型、上下班时间）
- 调整排班后系统发送通知给被调整的人员
- 支持三种班次：白班(day)、夜班(night)、休息(rest)
- 查看所有人员的考勤记录，支持按人员、日期范围、考勤状态筛选
- 查看每日考勤汇总（正常/迟到/早退/缺勤人数统计）
- 对缺勤或异常考勤记录进行补卡操作（补录上班/下班打卡时间）
- 补卡后系统重新计算该条考勤的状态和工作时长
- 补卡记录需在备注中标注"经理补卡"及补卡原因
- 支持查看月度考勤统计报表

### 5.6：消息中心
作为经理，我希望收到业务相关的消息通知，以便及时了解工作动态。

验收标准：
- 通知类型：审批通知(approval)、系统通知(system)
- 通知包含标题、内容、关联业务ID
- 支持标记已读/未读

### 5.7：个人中心
作为经理，我希望查看和修改个人资料。

验收标准：
- 查看基本信息（姓名、部门、电话、邮箱等）
- 可修改联系电话和邮箱
- 可上传和更换头像（图片文件，最大15MB，存储到MinIO）
- 上传新头像后旧头像自动删除

---

## 六、系统管理员（admin）

> 侧边栏菜单：首页概览 | 用户管理 | 系统配置 | 操作日志 | 消息中心（待补充侧边栏菜单） | 个人中心

### 6.1：首页概览
作为系统管理员，我希望在首页看到系统运行状态概览。

验收标准：
- 显示系统用户总数、各角色用户数量
- 显示今日活跃用户数
- 显示系统运行状态信息

### 6.2：用户管理
作为系统管理员，我希望管理系统用户，以便维护用户权限。

验收标准：
- 查看用户列表，支持按角色筛选
- 添加新用户（设置用户名、密码、姓名、角色、部门等）
- 编辑用户信息
- 启用/禁用用户账号

### 6.3：系统配置
作为系统管理员，我希望管理系统参数配置。

验收标准：
- 配置电价参数（峰/平/谷电价）
- 配置预警阈值
- 其他系统参数设置

### 6.4：操作日志
作为系统管理员，我希望查看系统操作日志，以便审计和追踪。

验收标准：
- 记录用户的关键操作（操作类型、操作描述、IP地址、操作时间）
- 支持按用户、操作类型、时间范围查询
- 日志按时间倒序排列

### 6.5：消息中心
作为系统管理员，我希望收到系统相关的消息通知，以便及时了解系统动态。

验收标准：
- 通知类型：系统通知(system)
- 通知包含标题、内容、关联业务ID
- 支持标记已读/未读

### 6.6：个人中心
作为系统管理员，我希望查看和修改个人资料。

验收标准：
- 查看基本信息（姓名、部门、电话、邮箱等）
- 可修改联系电话和邮箱
- 可上传和更换头像（图片文件，最大15MB，存储到MinIO）
- 上传新头像后旧头像自动删除

---

## 七、系统级需求

### 7.1：能耗数据自动生成
作为系统，我需要为已批准的用电申请自动生成能耗数据。

验收标准：
- 已批准的申请按小时生成能耗记录
- 每条记录包含：功率(kW)、电量(kWh)、时段类型、电价、费用
- 时段类型：峰时(peak, 8-12点和18-22点)、平时(normal, 12-18点)、谷时(valley, 22-8点)
- 电价：峰时1.2元/kWh、平时0.8元/kWh、谷时0.4元/kWh

### 7.2：车间配额管理
作为系统，我需要管理各车间的月度用电配额。

验收标准：
- 每个车间按月设置总配额(kWh)
- 实时追踪已用配额
- 配额数据按车间和年月唯一标识

### 7.3：文件存储服务
作为系统，我需要提供统一的文件上传和管理服务。

验收标准：
- 基于MinIO对象存储，支持文件上传、删除、获取访问URL
- 文件名格式：userId_timestamp.扩展名，保证唯一性
- 自动创建存储桶并设置公开读取策略
- 生成预签名URL（有效期7天）用于文件访问
- 支持图片类型验证和文件大小限制（最大15MB）

---

## 技术约束

- 后端：Spring Boot 3.2 + Java 17 + MyBatis-Plus 3.5 + MySQL
- 前端：Vue 3 + Vite 5 + Element Plus + ECharts + Pinia + Vue Router 4 + Bootstrap 5 + SCSS
- 文件存储：MinIO 对象存储
- AI服务：讯飞星火大模型（WebSocket通信）
- 测试：JUnit 5 + jqwik（属性测试）+ H2（测试数据库）
- API路径前缀：/api
- 前端开发端口：3000，后端API端口：8080