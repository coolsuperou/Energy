import{p as ts,r as p,q as $,k as es,c as r,b as s,s as u,v as h,t as o,n as D,g as i,l as M,x as E,e as ns,F as j,m as W,y as A,z as y,o as d,E as b,A as U}from"./index-DIcO2vH9.js";import{g as ls,s as as}from"./application-Dl1OK2DR.js";function os(N){return ts.get("/equipments",{params:{workshopId:N}})}const is={class:"apply-page"},rs={class:"quota-section"},us={class:"stat-card"},ds={class:"stat-item"},ps={class:"fw-bold"},vs={class:"stat-item"},cs={class:"fw-bold text-success"},ms={class:"stat-item"},bs={class:"fw-bold text-warning"},gs={class:"stat-item"},fs={class:"fw-bold text-danger"},ws={class:"tabs"},ys={key:0,class:"badge"},Cs={class:"card"},ks={class:"card-body"},qs={class:"form-row"},xs={class:"form-group"},Ts=["value"],Ds={class:"form-group"},Is={class:"form-row form-row-3"},Ls={class:"form-group"},js=["min"],As={class:"form-group"},Ns={class:"form-group"},Ss={class:"form-row"},Vs={class:"form-group"},$s={class:"form-group"},hs={class:"estimate-box"},Ms={class:"estimate-info"},Es={class:"card"},Ws={class:"card-header"},Us={class:"table-responsive"},Rs={class:"table table-hover mb-0"},Fs={class:"fw-semibold text-primary"},Os=["onClick"],Bs=["onClick"],Hs=["onClick"],_s=["onClick"],zs={key:0},Ks={__name:"Apply",setup(N){const v=p("new"),C=p(""),R=p(""),I=p([]),g=p([]),k=p(0),q=p(0),c=p({total:0,approved:0,pending:0,rejected:0}),l=p({equipmentId:"",power:"",applyDate:"",startTime:"08:00",endTime:"12:00",urgency:"NORMAL",purpose:""}),F=$(()=>new Date().toISOString().split("T")[0]),O=$(()=>C.value?g.value.filter(e=>(e.status||"").toLowerCase()===C.value.toLowerCase()):g.value);function B(){const e=I.value.find(t=>t.id===l.value.equipmentId);e&&(l.value.power=e.ratedPower),f()}function f(){const e=l.value.power||0,t=l.value.startTime,n=l.value.endTime;if(!t||!n||!e){k.value=0,q.value=0;return}const a=parseInt(t.split(":")[0]),m=parseInt(n.split(":")[0]),w=m>a?m-a:24-a+m,x=e*w;let T=.8;a>=8&&a<11||a>=18&&a<21?T=1.2:(a>=23||a<7)&&(T=.4),k.value=x,q.value=(x*T).toFixed(0)}function H(e){const t=(e||"").toLowerCase();return{pending:"待审批",approved:"已批准",rejected:"已拒绝",adjusted:"已调整"}[t]||e}function _(e){const t=(e||"").toLowerCase();return{pending:"bg-warning text-dark",approved:"bg-success",rejected:"bg-danger",adjusted:"bg-success"}[t]||"bg-secondary"}function z(e){const t=(e||"").toLowerCase();return t==="rejected"?"text-danger small":t==="approved"||t==="adjusted"?"text-success small":"text-muted"}function P(e){return(e||"").toLowerCase()==="pending"}function G(e){return(e||"").toLowerCase()==="rejected"}function J(e,t,n){return e?`${e.substring(5)} ${t}-${n}`:"-"}async function K(){try{const e=await os();e.code===200&&(I.value=e.data||[])}catch(e){console.error("加载设备失败",e)}}async function L(){try{const e=await ls({page:1,size:100});e.code===200&&(g.value=e.data.records||e.data||[],Q())}catch(e){console.error("加载申请失败",e)}}function Q(){const e=g.value;c.value={total:e.length,approved:e.filter(t=>{const n=(t.status||"").toLowerCase();return n==="approved"||n==="adjusted"}).length,pending:e.filter(t=>(t.status||"").toLowerCase()==="pending").length,rejected:e.filter(t=>(t.status||"").toLowerCase()==="rejected").length}}async function X(){if(!l.value.equipmentId){b.warning("请选择用电设备");return}if(!l.value.power||l.value.power<=0){b.warning("请输入有效的申请功率");return}if(!l.value.applyDate){b.warning("请选择申请日期");return}try{(await as(l.value)).code===200&&(b.success("申请提交成功"),S(),L(),v.value="list")}catch{}}function S(){l.value={equipmentId:"",power:"",applyDate:"",startTime:"08:00",endTime:"12:00",urgency:"NORMAL",purpose:""},R.value="",k.value=0,q.value=0}function Y(e){U.confirm("确定要撤回此申请吗？","提示",{type:"warning"}).then(()=>{b.success("撤回成功"),L()}).catch(()=>{})}function V(e){U.alert(`申请编号: ${e.applicationNo}
用途: ${e.purpose||"-"}
审批意见: ${e.comment||"-"}`,"申请详情")}function Z(e){const t=e.power||0,n=e.startTime,a=e.endTime;if(!n||!a||!t)return 0;const m=parseInt(n.split(":")[0]),w=parseInt(a.split(":")[0]),x=w>m?w-m:24-m+w;return(t*x*.8).toFixed(0)}function ss(e){l.value={equipmentId:e.equipmentId||"",power:e.power,applyDate:e.applyDate,startTime:e.startTime,endTime:e.endTime,urgency:e.urgency||"NORMAL",purpose:e.purpose||""},v.value="new",b.info("已填充原申请信息，请修改后重新提交")}return es(()=>{l.value.applyDate=new Date(Date.now()+864e5).toISOString().split("T")[0],K(),L()}),(e,t)=>(d(),r("div",is,[s("div",rs,[t[15]||(t[15]=h('<div class="quota-card"><div class="quota-header"><div class="quota-info"><h6>本月用电配额</h6><div class="quota-value"><span class="current">35,680</span><span class="total">/ 50,000 kWh</span></div></div><div class="quota-remain"><div class="label">剩余配额</div><div class="value">14,320 kWh</div></div></div><div class="quota-progress"><div class="quota-progress-bar" style="width:71.4%;"></div></div><div class="quota-footer"><span>已使用 71.4%</span><span>本月剩余 16 天</span></div></div>',1)),s("div",us,[t[14]||(t[14]=s("h6",null,"申请统计",-1)),s("div",ds,[t[10]||(t[10]=s("span",null,"本月申请",-1)),s("span",ps,o(c.value.total)+" 次",1)]),s("div",vs,[t[11]||(t[11]=s("span",null,"已批准",-1)),s("span",cs,o(c.value.approved)+" 次",1)]),s("div",ms,[t[12]||(t[12]=s("span",null,"待审批",-1)),s("span",bs,o(c.value.pending)+" 次",1)]),s("div",gs,[t[13]||(t[13]=s("span",null,"已拒绝",-1)),s("span",fs,o(c.value.rejected)+" 次",1)])])]),s("div",ws,[s("button",{class:D(["tab-btn",{active:v.value==="new"}]),onClick:t[0]||(t[0]=n=>v.value="new")},"新建申请",2),s("button",{class:D(["tab-btn",{active:v.value==="list"}]),onClick:t[1]||(t[1]=n=>v.value="list")},[t[16]||(t[16]=i(" 申请记录 ",-1)),c.value.pending>0?(d(),r("span",ys,o(c.value.pending),1)):M("",!0)],2)]),u(s("div",Cs,[t[36]||(t[36]=s("div",{class:"card-header"},"填写用电申请",-1)),s("div",ks,[s("form",{class:"apply-form",onSubmit:ns(X,["prevent"])},[t[33]||(t[33]=s("h6",{class:"section-title"},[s("i",{class:"bi bi-cpu"}),i("用电设备")],-1)),s("div",qs,[s("div",xs,[t[18]||(t[18]=s("label",null,[i("设备名称 "),s("span",{class:"required"},"*")],-1)),u(s("select",{"onUpdate:modelValue":t[2]||(t[2]=n=>l.value.equipmentId=n),class:"form-select",onChange:B},[t[17]||(t[17]=s("option",{value:""},"请选择设备",-1)),(d(!0),r(j,null,W(I.value,n=>(d(),r("option",{key:n.id,value:n.id},o(n.name)+" (额定功率: "+o(n.ratedPower)+"kW) ",9,Ts))),128))],544),[[A,l.value.equipmentId]])]),s("div",Ds,[t[19]||(t[19]=s("label",null,[i("申请功率 (kW) "),s("span",{class:"required"},"*")],-1)),u(s("input",{"onUpdate:modelValue":t[3]||(t[3]=n=>l.value.power=n),type:"number",class:"form-input",placeholder:"请输入申请功率",min:"1",max:"200",onInput:f},null,544),[[y,l.value.power,void 0,{number:!0}]]),t[20]||(t[20]=s("div",{class:"form-hint"},[i("当前车间最大可用功率: "),s("strong",null,"200 kW")],-1))])]),t[34]||(t[34]=h('<h6 class="section-title"><i class="bi bi-clock"></i>用电时段 <span class="hint">(参考电价)</span></h6><div class="time-slots"><div class="time-slot peak"><div class="slot-header"><span class="slot-name text-danger">峰时</span><span class="slot-price bg-danger">电价 1.2元/kWh</span></div><div class="slot-time">08:00 - 11:00<br>18:00 - 21:00</div></div><div class="time-slot normal"><div class="slot-header"><span class="slot-name text-warning">平时</span><span class="slot-price bg-warning">电价 0.8元/kWh</span></div><div class="slot-time">07:00 - 08:00, 11:00 - 18:00<br>21:00 - 23:00</div></div><div class="time-slot valley"><div class="slot-header"><span class="slot-name text-success">谷时</span><span class="slot-price bg-success">电价 0.4元/kWh</span></div><div class="slot-time">23:00 - 07:00</div></div></div>',2)),s("div",Is,[s("div",Ls,[t[21]||(t[21]=s("label",null,[i("申请日期 "),s("span",{class:"required"},"*")],-1)),u(s("input",{"onUpdate:modelValue":t[4]||(t[4]=n=>l.value.applyDate=n),type:"date",class:"form-input",min:F.value},null,8,js),[[y,l.value.applyDate]])]),s("div",As,[t[22]||(t[22]=s("label",null,[i("开始时间 "),s("span",{class:"required"},"*")],-1)),u(s("input",{"onUpdate:modelValue":t[5]||(t[5]=n=>l.value.startTime=n),type:"time",class:"form-input",onChange:f},null,544),[[y,l.value.startTime]])]),s("div",Ns,[t[23]||(t[23]=s("label",null,[i("结束时间 "),s("span",{class:"required"},"*")],-1)),u(s("input",{"onUpdate:modelValue":t[6]||(t[6]=n=>l.value.endTime=n),type:"time",class:"form-input",onChange:f},null,544),[[y,l.value.endTime]])])]),t[35]||(t[35]=s("h6",{class:"section-title"},[s("i",{class:"bi bi-file-text"}),i("用途说明")],-1)),s("div",Ss,[s("div",Vs,[t[25]||(t[25]=s("label",null,"紧急程度",-1)),u(s("select",{"onUpdate:modelValue":t[7]||(t[7]=n=>l.value.urgency=n),class:"form-select"},[...t[24]||(t[24]=[s("option",{value:"NORMAL"},"普通",-1),s("option",{value:"URGENT"},"紧急",-1),s("option",{value:"CRITICAL"},"非常紧急",-1)])],512),[[A,l.value.urgency]])]),s("div",$s,[t[26]||(t[26]=s("label",null,"详细说明",-1)),u(s("textarea",{"onUpdate:modelValue":t[8]||(t[8]=n=>l.value.purpose=n),class:"form-textarea",rows:"2",placeholder:"请描述用电用途和具体需求..."},null,512),[[y,l.value.purpose]])])]),s("div",hs,[s("div",Ms,[t[30]||(t[30]=s("i",{class:"bi bi-calculator"},null,-1)),s("span",null,[t[27]||(t[27]=i("预估用电量: ",-1)),s("strong",null,o(k.value),1),t[28]||(t[28]=i(" kWh",-1))]),t[31]||(t[31]=s("span",{class:"divider"},"|",-1)),s("span",null,[t[29]||(t[29]=i("预估费用: ",-1)),s("strong",null,"¥"+o(q.value),1)])]),s("button",{type:"button",class:"btn-calc",onClick:f},"重新计算")]),s("div",{class:"form-actions"},[s("button",{type:"button",class:"btn btn-outline",onClick:S},"重置"),t[32]||(t[32]=s("button",{type:"submit",class:"btn btn-primary"},[s("i",{class:"bi bi-send"}),i("提交申请")],-1))])],32)])],512),[[E,v.value==="new"]]),u(s("div",Es,[s("div",Ws,[t[38]||(t[38]=s("span",null,"申请记录",-1)),u(s("select",{"onUpdate:modelValue":t[9]||(t[9]=n=>C.value=n),class:"filter-select"},[...t[37]||(t[37]=[s("option",{value:""},"全部状态",-1),s("option",{value:"pending"},"待审批",-1),s("option",{value:"approved"},"已批准",-1),s("option",{value:"rejected"},"已拒绝",-1)])],512),[[A,C.value]])]),s("div",Us,[s("table",Rs,[t[40]||(t[40]=s("thead",null,[s("tr",null,[s("th",null,"申请编号"),s("th",null,"设备/用途"),s("th",null,"申请时段"),s("th",null,"功率"),s("th",null,"预估费用"),s("th",null,"状态"),s("th",null,"审批意见"),s("th",null,"操作")])],-1)),s("tbody",null,[(d(!0),r(j,null,W(O.value,n=>(d(),r("tr",{key:n.id},[s("td",Fs,o(n.applicationNo),1),s("td",null,o(n.equipmentName||"-")+" · "+o(n.purpose||"生产用电"),1),s("td",null,o(J(n.applyDate,n.startTime,n.endTime)),1),s("td",null,o(n.power)+" kW",1),s("td",null,"¥"+o(Z(n)),1),s("td",null,[s("span",{class:D(["badge",_(n.status)])},o(H(n.status)),3)]),s("td",{class:D(z(n.status))},o(n.comment||"-"),3),s("td",null,[P(n.status)?(d(),r("button",{key:0,class:"btn btn-sm btn-outline-danger",onClick:a=>Y(n.id)},"撤回",8,Os)):G(n.status)?(d(),r(j,{key:1},[s("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:a=>V(n)},"详情",8,Bs),s("button",{class:"btn btn-sm btn-primary",onClick:a=>ss(n)},"重新申请",8,Hs)],64)):(d(),r("button",{key:2,class:"btn btn-sm btn-outline-primary",onClick:a=>V(n)},"详情",8,_s))])]))),128)),g.value.length===0?(d(),r("tr",zs,[...t[39]||(t[39]=[s("td",{colspan:"8",class:"text-center text-muted py-4"},"暂无申请记录",-1)])])):M("",!0)])])])],512),[[E,v.value==="list"]])]))}};export{Ks as default};
